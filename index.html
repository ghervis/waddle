<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waddle</title>
    <meta name="description" content="ğŸ¦† Waddle waddle..." />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

    <!-- Open Graph / Discord Embed -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Waddle" />
    <meta property="og:description" content="ğŸ¦† Waddle waddle..." />
    <meta property="og:url" content="https://ghervis.github.io/waddle" />
    <meta property="og:site_name" content="Waddle" />
    <meta
      property="og:image"
      content="https://ghervis.github.io/waddle/favicon.png"
    />
    <meta property="og:image:width" content="256" />
    <meta property="og:image:height" content="256" />
    <meta
      property="og:image:alt"
      content="Yellow rubber duck head - Waddle racing game logo"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Waddle" />
    <meta name="twitter:description" content="ğŸ¦† Waddle waddle..." />
    <meta
      name="twitter:image"
      content="https://ghervis.github.io/waddle/favicon.png"
    />

    <!-- Theme Color (Yellow for Discord embed border) -->
    <meta name="theme-color" content="#FFD700" />
    <meta name="msapplication-TileColor" content="#FFD700" />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Volume Control Button -->
    <button class="volume-btn" id="volumeBtn" onclick="toggleVolume()">
      ğŸ”Š
    </button>

    <!-- Background Music -->
    <audio id="backgroundMusic" loop>
      <source src="duck-song.mp3" type="audio/mpeg" />
    </audio>

    <!-- Finish Cheering Sound -->
    <audio id="finishCheering" preload="auto">
      <source src="finish-cheering.mp3" type="audio/mpeg" />
    </audio>
    <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()">
      â—€
    </button>

    <div class="sidebar" id="sidebar">
      <!-- Header with title and buttons -->
      <div class="sidebar-header">
        <h2>ğŸ¦† Racers</h2>
        <div class="header-buttons">
          <button id="addRacerBtn" class="header-btn add-btn">â• Add</button>
          <div class="race-mode-toggle">
            <input type="checkbox" id="raceModeToggle" class="toggle-input" />
            <label for="raceModeToggle" class="toggle-label">
              <span class="toggle-text casual">Casual</span>
              <span class="toggle-text ranked">Ranked</span>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <button id="startBtn" class="header-btn start-btn">
            ğŸ <span class="startBtn-text">Start</span>
          </button>
        </div>
      </div>
      <div class="sidebar-content">
        <div id="leaderboard" class="leaderboard"></div>

        <details class="skill-list" id="skillsSection">
          <summary>
            <h3 style="display: inline">ğŸª„ Skills</h3>
          </summary>
          <div class="skill-item">
            <strong>â© Boost:</strong> +10% speed for 3s
          </div>
          <div class="skill-item">
            <strong>ğŸ’£ Bomb:</strong> Stun leader for 2s
          </div>
          <div class="skill-item">
            <strong>ğŸŒŠ Splash:</strong> -5% speed to all, +5% per affected to
            caster for 2s
          </div>
          <div class="skill-item">
            <strong>ğŸ›¡ï¸ Immune:</strong> Immune to skills for 2s
          </div>
          <div class="skill-item">
            <strong>âš¡ Lightning:</strong> Stun others for 1s (last place only)
          </div>
          <div class="skill-item">
            <strong>ğŸ§² Magnet:</strong> Speed boost based on distance from
            leader (last place only)
          </div>
        </details>

        <details class="race-log-list" id="raceLogSection">
          <summary>
            <h3 style="display: inline">ğŸ“‹ Race Log</h3>
          </summary>
          <div id="log" class="log"></div>
        </details>

        <details
          class="leaderboard-list"
          id="leaderboardSection"
          style="display: none"
        >
          <summary>
            <h3 style="display: inline">ğŸŒ Online Leaderboard</h3>
          </summary>
          <div id="globalLeaderboard" class="global-leaderboard"></div>
        </details>

        <!-- Settings Button -->
        <!-- prettier-ignore -->
        <div class="sidebar-bottom-content">

        <button
        class="settings-btn"
        id="settingsBtn"
        onclick="window.game.openSettingsDialog()"
      >âš™ï¸<span class="settings-btn-text">&nbsp;Settings</span>
      </button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="title-container">
        <div class="title-input-wrapper">
          <input
            type="text"
            id="raceTitle"
            class="race-title-input"
            value="Waddle Waddle"
            maxlength="50"
          />
          <button class="edit-title-btn" onclick="focusRaceTitle()">âœï¸</button>
        </div>
      </div>
      <div class="game-container">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
      </div>
    </div>

    <!-- Settings Dialog (moved from JS) -->
    <dialog class="settings-dialog" id="settingsDialog">
      <div class="dialog-content">
        <button
          class="dialog-close-btn"
          onclick="document.getElementById('settingsDialog').close()"
        >
          Ã—
        </button>
        <h3>âš™ï¸ Settings</h3>

        <div class="settings-scrollable">
          <div class="settings-section webhook">
            <h4>ğŸ”— Discord Webhook</h4>
            <p>Send race results to your Discord channel</p>
            <input
              type="url"
              id="discordWebhookUrl"
              placeholder="https://discord.com/api/webhooks/..."
              value=""
              onchange="window.game && window.game.autoSaveSettings()"
            />
          </div>

          <div class="settings-section music">
            <h4>ğŸµ Audio</h4>
            <p>Control the volume of background music during races</p>
            <label
              for="musicVolumeSlider"
              style="display: block; margin-bottom: 5px; font-weight: bold"
              >Volume:</label
            >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 10px;
              "
            >
              <input
                type="range"
                id="musicVolumeSlider"
                min="0"
                max="100"
                value="30"
                style="flex: 1"
              />
              <button
                id="musicMuteBtn"
                class="mute-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  border: none;
                  background: #ddd;
                  cursor: pointer;
                  font-size: 18px;
                "
              >
                ğŸ”Š
              </button>
            </div>

            <label
              for="voiceSelect"
              style="display: block; margin: 15px 0 5px 0; font-weight: bold"
              >Voice:</label
            >
            <select
              id="voiceSelect"
              style="
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            ></select>

            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 10px;
              "
            >
              <span style="font-weight: bold">Announcer Mute:</span>
              <button
                id="speechMuteBtn"
                class="mute-btn"
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  border: none;
                  background: #ddd;
                  cursor: pointer;
                  font-size: 18px;
                "
              >
                ğŸ”Š
              </button>
            </div>

            <label
              for="speechVolumeSlider"
              style="display: block; margin: 15px 0 5px 0; font-weight: bold"
              >Voice Volume:</label
            >
            <input
              type="range"
              id="speechVolumeSlider"
              min="0"
              max="100"
              value="50"
              style="width: 100%; padding: 8px; margin-bottom: 10px"
            />
          </div>

          <div class="settings-section export">
            <h4>ğŸ“¤ Export Profile</h4>
            <p>Export your profile to be accessed on other device(s)</p>
            <button
              id="exportProfileBtn"
              class="export-profile-btn"
              onclick="window.game && window.game.copyProfileLink()"
            >
              ğŸ“‹ Click to copy link
            </button>
            <div id="copyStatus" class="copy-status"></div>
          </div>

          <div class="settings-section danger">
            <h4>âš ï¸ Danger Zone</h4>
            <button
              id="resetDataBtn"
              class="reset-data-btn"
              onmousedown="window.game && window.game.startResetHold()"
              onmouseup="window.game && window.game.stopResetHold()"
              onmouseleave="window.game && window.game.stopResetHold()"
              ontouchstart="window.game && window.game.startResetHold(event)"
              ontouchend="window.game && window.game.stopResetHold()"
              ontouchcancel="window.game && window.game.stopResetHold()"
            >
              <span id="resetBtnText">ğŸ—‘ï¸ Hold to Reset All Data (4s)</span>
              <div id="resetProgress" class="reset-progress"></div>
            </button>
          </div>
        </div>

        <div class="dialog-buttons">
          <button onclick="document.getElementById('settingsDialog').close()">
            Close
          </button>
        </div>
      </div>
    </dialog>

    <!-- Edit Racer Dialog (moved from JS) -->
    <dialog class="settings-dialog" id="editRacerDialog">
      <div class="dialog-content">
        <button
          class="dialog-close-btn"
          onclick="document.getElementById('editRacerDialog').close()"
        >
          Ã—
        </button>
        <h3 id="editRacerTitle">Edit Racer</h3>
        <form id="editRacerForm">
          <label for="editDialogRacerName"
            >Name (2-16 alphanumeric characters) *</label
          >
          <input
            type="text"
            id="editDialogRacerName"
            name="racerName"
            placeholder="Duck name"
            pattern="[A-Za-z0-9]{2,16}"
            minlength="2"
            maxlength="16"
            required
          />
          <div id="nameError">
            Name must be 2-16 alphanumeric characters only
          </div>

          <div
            class="file-upload-area"
            onclick="document.getElementById('editDialogImageFile').click()"
            ondrop="window.game && window.game.handleImageDrop(event, 'edit')"
            ondragover="window.game && window.game.handleDragOver(event)"
            ondragleave="window.game && window.game.handleDragLeave(event)"
          >
            <div>ğŸ“· Click or drag to upload profile picture</div>
            <div class="upload-hint">Will be resized to 64x64 pixels</div>
            <div id="editDialogImagePreview"></div>
          </div>
          <input
            type="file"
            id="editDialogImageFile"
            accept="image/*"
            onchange="window.game && window.game.handleImageUpload(event, 'edit')"
          />

          <label for="editDialogColorPicker" class="color-picker-label"
            >Select Color ğŸ¨</label
          >
          <input
            type="color"
            id="editDialogColorPicker"
            class="color-picker"
            value="#FFD700"
          />
          <div class="dialog-buttons">
            <button
              type="button"
              onclick="document.getElementById('editRacerDialog').close()"
            >
              Cancel
            </button>
            <button type="submit">Update Duck</button>
          </div>
        </form>
      </div>
    </dialog>

    <!-- Add Racer Dialog (moved from JS) -->
    <dialog class="settings-dialog" id="addRacerDialog">
      <div class="dialog-content">
        <button
          class="dialog-close-btn"
          onclick="document.getElementById('addRacerDialog').close()"
        >
          Ã—
        </button>
        <h3>Add New Racer</h3>
        <input
          type="text"
          id="addDialogRacerName"
          placeholder="Duck name"
          maxlength="32"
        />

        <div
          class="file-upload-area"
          onclick="document.getElementById('addDialogImageFile').click()"
          ondrop="window.game && window.game.handleImageDrop(event, 'add')"
          ondragover="window.game && window.game.handleDragOver(event)"
          ondragleave="window.game && window.game.handleDragLeave(event)"
        >
          <div>ğŸ“· Click or drag to upload profile picture</div>
          <div class="upload-hint">Will be resized to 64x64 pixels</div>
          <div id="addDialogImagePreview"></div>
        </div>
        <input
          type="file"
          id="addDialogImageFile"
          accept="image/*"
          onchange="window.game && window.game.handleImageUpload(event, 'add')"
        />

        <label for="addDialogColorPicker" class="color-picker-label"
          >Select Color ğŸ¨</label
        >
        <input
          type="color"
          id="addDialogColorPicker"
          class="color-picker"
          value="#FFD700"
        />
        <div class="dialog-buttons">
          <button
            type="button"
            onclick="document.getElementById('addRacerDialog').close()"
          >
            Cancel
          </button>
          <button
            type="button"
            onclick="window.game && window.game.addRacerFromDialog()"
          >
            Add Duck
          </button>
        </div>
      </div>
    </dialog>
    <!-- Remove Racer Dialog -->
    <dialog class="settings-dialog" id="removeRacerDialog">
      <div class="dialog-content">
        <button
          class="dialog-close-btn"
          onclick="document.getElementById('removeRacerDialog').close()"
        >
          Ã—
        </button>
        <h3>Remove Racer</h3>
        <p id="removeRacerMessage">
          Are you sure you want to remove this racer?
        </p>
        <div class="dialog-buttons">
          <button
            onclick="document.getElementById('removeRacerDialog').close()"
          >
            Cancel
          </button>
          <button onclick="window.game.removeRacerConfirmed()">Remove</button>
        </div>
      </div>
    </dialog>
    <script src="common-utilities.js"></script>
    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const btn = document.getElementById("collapseBtn");

        sidebar.classList.toggle("collapsed");
        btn.classList.toggle("collapsed");
        btn.textContent = sidebar.classList.contains("collapsed") ? "â–¶" : "â—€";
      }

      // Volume control functionality
      let isMuted = localStorage.getItem("volumeMuted") === "true";
      const backgroundMusic = document.getElementById("backgroundMusic");
      const volumeBtn = document.getElementById("volumeBtn");

      function toggleVolume() {
        isMuted = !isMuted;
        localStorage.setItem("volumeMuted", isMuted);
        backgroundMusic.muted = isMuted;
        volumeBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        volumeBtn.classList.toggle("muted", isMuted);

        // Update settings mute button if it exists
        const musicMuteBtn = document.getElementById("musicMuteBtn");
        if (musicMuteBtn) {
          musicMuteBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
          musicMuteBtn.classList.toggle("muted", isMuted);
        }

        const musicVolumeSlider = document.getElementById("musicVolumeSlider");
        if (musicVolumeSlider) {
          if (isMuted) {
            // Mute: set slider to 0
            musicVolumeSlider.value = 0;
          } else {
            // Unmute: restore to previous volume
            musicVolumeSlider.value = Math.round(musicVolume * 100);
            backgroundMusic.volume = musicVolume;
          }
        }
      }

      // Load music volume
      let musicVolume = parseFloat(localStorage.getItem("musicVolume")) || 0.3;
      let previousVolume = musicVolume; // Track last non-zero volume for restore on unmute

      // Initialize background music with saved state
      backgroundMusic.volume = musicVolume;
      backgroundMusic.muted = isMuted;
      volumeBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
      volumeBtn.classList.toggle("muted", isMuted);

      // Play music when race starts
      window.playBackgroundMusic = function () {
        backgroundMusic.play().catch((error) => {
          console.log("Could not play background music:", error);
        });
      };

      // Stop music when race ends
      window.stopBackgroundMusic = function () {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      };

      // Function to focus the race title input when pencil is clicked
      function focusRaceTitle() {
        const raceTitle = document.getElementById("raceTitle");
        raceTitle.focus();
        raceTitle.select();
      }

      // Race mode toggle functionality
      const raceModeToggle = document.getElementById("raceModeToggle");
      const startBtn = document.getElementById("startBtn");

      // Load saved race mode preference
      const savedRaceMode = localStorage.getItem("raceMode") || "casual";
      raceModeToggle.checked = savedRaceMode === "ranked";
      updateStartButtonColor();

      raceModeToggle.addEventListener("change", async function () {
        const raceMode = this.checked ? "ranked" : "casual";
        console.log("raceMode changed to:", raceMode);
        localStorage.setItem("raceMode", raceMode);

        if ("ranked" === raceMode) {
          await window.game.generateRankedRacerId();
          await window.game.fetchOnlineLeaderboard();
        }
        updateStartButtonColor();
        updateSectionVisibility();

        // Update the racers display immediately when mode changes
        if (window.game) {
          window.game.stopRace();
        }
      });

      // Handle section visibility and collapsing
      function updateSectionVisibility() {
        const leaderboardSection =
          document.getElementById("leaderboardSection");
        const skillsSection = document.getElementById("skillsSection");

        if (raceModeToggle.checked) {
          // Ranked mode: show leaderboard
          leaderboardSection.style.display = "block";
          if (window.game) {
            window.game.updateOnlineLeaderboard();
          }
        } else {
          // Casual mode: hide leaderboard
          leaderboardSection.style.display = "none";
        }
      }

      // Add event listeners for section toggling
      document.addEventListener("DOMContentLoaded", function () {
        const leaderboardSection =
          document.getElementById("leaderboardSection");
        const skillsSection = document.getElementById("skillsSection");
        const raceLogSection = document.getElementById("raceLogSection");

        const sections = [
          skillsSection,
          raceLogSection,
          leaderboardSection,
        ].filter(Boolean);

        sections.forEach((section) => {
          section.addEventListener("toggle", function () {
            if (this.open) {
              // Close all other sections when this one opens
              sections.forEach((otherSection) => {
                if (otherSection !== this) {
                  otherSection.removeAttribute("open");
                }
              });
            }
          });
        });

        window.speechSynthesis.getVoices();

        // Music volume slider handler
        const musicVolumeSlider = document.getElementById("musicVolumeSlider");
        if (musicVolumeSlider) {
          musicVolumeSlider.value = isMuted ? 0 : Math.round(musicVolume * 100);
          musicVolumeSlider.addEventListener("input", function (e) {
            const newVolume = parseFloat(e.target.value) / 100;
            if (isMuted && newVolume > 0) {
              // If muted and sliding to >0, unmute
              isMuted = false;
              backgroundMusic.muted = false;
              localStorage.setItem("volumeMuted", "false");

              // Update buttons
              volumeBtn.textContent = "ğŸ”Š";
              volumeBtn.classList.remove("muted");

              const musicMuteBtn = document.getElementById("musicMuteBtn");
              if (musicMuteBtn) {
                musicMuteBtn.textContent = "ğŸ”Š";
                musicMuteBtn.classList.remove("muted");
              }
            }
            backgroundMusic.volume = newVolume;
            musicVolume = newVolume;
            localStorage.setItem("musicVolume", newVolume);
          });
        }

        // Settings mute button init and sync
        const musicMuteBtn = document.getElementById("musicMuteBtn");
        if (musicMuteBtn) {
          musicMuteBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
          musicMuteBtn.classList.toggle("muted", isMuted);
          musicMuteBtn.addEventListener("click", toggleVolume);
        }
      });

      // Initial section visibility update
      updateSectionVisibility();

      function updateStartButtonColor() {
        if (raceModeToggle.checked) {
          // Ranked mode - crimson color
          startBtn.style.background = "#DC143C";
          startBtn.style.borderColor = "#a0102a";
        } else {
          // Casual mode - green color
          startBtn.style.background = "#228B22";
          startBtn.style.borderColor = "#1a6b1a";
        }
      } // Function to disable/enable race mode toggle based on race state
      function updateRaceModeToggleState(raceActive) {
        raceModeToggle.disabled = raceActive;
      }

      // Make the function available globally for duck-race.js
      window.updateRaceModeToggleState = updateRaceModeToggleState;
    </script>
    <script src="duck-names.js"></script>
    <script src="race-simulator.js"></script>
    <script src="duck-race.js"></script>
  </body>
</html>
