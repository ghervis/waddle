<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waddle</title>
    <meta name="description" content="ğŸ¦† Waddle waddle..." />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Open Graph / Discord Embed -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Waddle" />
    <meta property="og:description" content="ğŸ¦† Waddle waddle..." />
    <meta property="og:url" content="https://ghervis.github.io/waddle" />
    <meta property="og:site_name" content="Waddle" />
    <meta
      property="og:image"
      content="https://ghervis.github.io/waddle/favicon.png"
    />
    <meta property="og:image:width" content="256" />
    <meta property="og:image:height" content="256" />
    <meta
      property="og:image:alt"
      content="Yellow rubber duck head - Waddle racing game logo"
    />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Waddle" />
    <meta name="twitter:description" content="ğŸ¦† Waddle waddle..." />
    <meta
      name="twitter:image"
      content="https://ghervis.github.io/waddle/favicon.png"
    />

    <!-- Theme Color (Yellow for Discord embed border) -->
    <meta name="theme-color" content="#FFD700" />
    <meta name="msapplication-TileColor" content="#FFD700" />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Volume Control Button -->
    <button class="volume-btn" id="volumeBtn" onclick="toggleVolume()">
      ğŸ”Š
    </button>

    <!-- Background Music -->
    <audio id="backgroundMusic" loop>
      <source src="duck-song.mp3" type="audio/mpeg" />
    </audio>

    <button class="collapse-btn" id="collapseBtn" onclick="toggleSidebar()">
      â—€
    </button>

    <div class="sidebar" id="sidebar">
      <!-- Header with title and buttons -->
      <div class="sidebar-header">
        <h2>ğŸ¦† Racers</h2>
        <div class="header-buttons">
          <div class="race-mode-toggle">
            <input type="checkbox" id="raceModeToggle" class="toggle-input" />
            <label for="raceModeToggle" class="toggle-label">
              <span class="toggle-text casual">Casual</span>
              <span class="toggle-text ranked">Ranked</span>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <button id="addRacerBtn" class="header-btn add-btn">â• Add</button>
          <button id="startBtn" class="header-btn start-btn">
            ğŸ <span class="startBtn-text">Start</span>
          </button>
        </div>
      </div>
      <div class="sidebar-content">
        <div id="leaderboard" class="leaderboard"></div>

        <details class="skill-list" id="skillsSection">
          <summary>
            <h3 style="display: inline">Skills</h3>
          </summary>
          <div class="skill-item">
            <strong>â© Boost:</strong> +10% speed for 3s
          </div>
          <div class="skill-item">
            <strong>ğŸ’£ Bomb:</strong> Stun leader for 2s
          </div>
          <div class="skill-item">
            <strong>ğŸŒŠ Splash:</strong> -5% speed to all, +5% per affected to
            caster for 2s
          </div>
          <div class="skill-item">
            <strong>ğŸ›¡ï¸ Immune:</strong> Immune to skills for 2s
          </div>
          <div class="skill-item">
            <strong>âš¡ Lightning:</strong> Stun others for 1s (last place only)
          </div>
          <div class="skill-item">
            <strong>ğŸ§² Magnet:</strong> Speed boost based on distance from
            leader (last place only)
          </div>
        </details>

        <details class="race-log-list" id="raceLogSection">
          <summary>
            <h3 style="display: inline">ğŸ“‹ Race Log</h3>
          </summary>
          <div id="log" class="log"></div>
        </details>

        <details
          class="leaderboard-list"
          id="leaderboardSection"
          style="display: none"
        >
          <summary>
            <h3 style="display: inline">ğŸŒ Online Leaderboard</h3>
          </summary>
          <div id="globalLeaderboard" class="global-leaderboard"></div>
        </details>

        <!-- Settings Button -->
        <!-- prettier-ignore -->
        <div class="sidebar-bottom-content">

        <button
        class="settings-btn"
        id="settingsBtn"
        onclick="window.game.openSettingsDialog()"
      >âš™ï¸<span class="settings-btn-text">&nbsp;Settings</span>
      </button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="title-container">
        <div class="title-input-wrapper">
          <input
            type="text"
            id="raceTitle"
            class="race-title-input"
            value="Waddle Waddle"
            maxlength="50"
          />
          <button class="edit-title-btn" onclick="focusRaceTitle()">âœï¸</button>
        </div>
      </div>
      <div class="game-container">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
      </div>
    </div>

    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const btn = document.getElementById("collapseBtn");

        sidebar.classList.toggle("collapsed");
        btn.classList.toggle("collapsed");
        btn.textContent = sidebar.classList.contains("collapsed") ? "â–¶" : "â—€";
      }

      // Volume control functionality
      let isMuted = localStorage.getItem("volumeMuted") === "true";
      const backgroundMusic = document.getElementById("backgroundMusic");
      const volumeBtn = document.getElementById("volumeBtn");

      function toggleVolume() {
        isMuted = !isMuted;
        localStorage.setItem("volumeMuted", isMuted);
        backgroundMusic.muted = isMuted;
        volumeBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        volumeBtn.classList.toggle("muted", isMuted);
      }

      // Initialize background music with saved state
      backgroundMusic.volume = 0.3; // 30% volume
      backgroundMusic.muted = isMuted;
      volumeBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
      volumeBtn.classList.toggle("muted", isMuted);

      // Play music when race starts
      window.playBackgroundMusic = function () {
        backgroundMusic.play().catch((error) => {
          console.log("Could not play background music:", error);
        });
      };

      // Stop music when race ends
      window.stopBackgroundMusic = function () {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      };

      // Function to focus the race title input when pencil is clicked
      function focusRaceTitle() {
        const raceTitle = document.getElementById("raceTitle");
        raceTitle.focus();
        raceTitle.select();
      }

      // Race mode toggle functionality
      const raceModeToggle = document.getElementById("raceModeToggle");
      const startBtn = document.getElementById("startBtn");

      // Load saved race mode preference
      const savedRaceMode = localStorage.getItem("raceMode") || "casual";
      raceModeToggle.checked = savedRaceMode === "ranked";
      updateStartButtonColor();

      raceModeToggle.addEventListener("change", async function () {
        const raceMode = this.checked ? "ranked" : "casual";
        console.log("raceMode changed to:", raceMode);
        localStorage.setItem("raceMode", raceMode);

        if ("ranked" === raceMode) {
          await window.game.generateRankedRacerId();
          await window.game.fetchOnlineLeaderboard();
        }
        updateStartButtonColor();
        updateSectionVisibility();

        // Update the racers display immediately when mode changes
        if (window.game) {
          window.game.stopRace();
          window.game.updateRacersList();
        }
      });

      // Handle section visibility and collapsing
      function updateSectionVisibility() {
        const leaderboardSection =
          document.getElementById("leaderboardSection");
        const skillsSection = document.getElementById("skillsSection");

        if (raceModeToggle.checked) {
          // Ranked mode: show leaderboard
          leaderboardSection.style.display = "block";
          if (window.game) {
            window.game.updateOnlineLeaderboard();
          }
        } else {
          // Casual mode: hide leaderboard
          leaderboardSection.style.display = "none";
        }
      }

      // Add event listeners for section toggling
      document.addEventListener("DOMContentLoaded", function () {
        const leaderboardSection =
          document.getElementById("leaderboardSection");
        const skillsSection = document.getElementById("skillsSection");
        const raceLogSection = document.getElementById("raceLogSection");

        const sections = [
          skillsSection,
          raceLogSection,
          leaderboardSection,
        ].filter(Boolean);

        sections.forEach((section) => {
          section.addEventListener("toggle", function () {
            if (this.open) {
              // Close all other sections when this one opens
              sections.forEach((otherSection) => {
                if (otherSection !== this) {
                  otherSection.removeAttribute("open");
                }
              });
            }
          });
        });
      });

      // Initial section visibility update
      updateSectionVisibility();

      function updateStartButtonColor() {
        if (raceModeToggle.checked) {
          // Ranked mode - crimson color
          startBtn.style.background = "#DC143C";
          startBtn.style.borderColor = "#a0102a";
        } else {
          // Casual mode - green color
          startBtn.style.background = "#228B22";
          startBtn.style.borderColor = "#1a6b1a";
        }
      } // Function to disable/enable race mode toggle based on race state
      function updateRaceModeToggleState(raceActive) {
        raceModeToggle.disabled = raceActive;
      }

      // Make the function available globally for duck-race.js
      window.updateRaceModeToggleState = updateRaceModeToggleState;
    </script>
    <script src="duck-names.js"></script>
    <script src="race-simulator.js"></script>
    <script src="duck-race.js"></script>
  </body>
</html>
